<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Messages - CringeBook</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Material Design 3 Color Scheme and Components */
        :root {
          --md-primary: #3f51b5;
          --md-primary-dark: #303f9f;
          --md-primary-light: #5c6bc0;
          --md-secondary: #03dac6;
          --md-surface: #ffffff;
          --md-surface-variant: #f5f5f5;
          --md-background: #fafafa;
          --md-error: #b00020;
          --md-on-primary: #ffffff;
          --md-on-surface: #000000;
          --md-on-background: #000000;
          --md-outline: #e0e0e0;
          --md-outline-variant: #f0f0f0;
          --md-border-radius-small: 8px;
          --md-border-radius-medium: 12px;
          --md-border-radius-large: 16px;
          --md-elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.12), 0px 1px 2px rgba(0, 0, 0, 0.24);
          --md-elevation-2: 0px 3px 6px rgba(0, 0, 0, 0.16), 0px 3px 6px rgba(0, 0, 0, 0.23);
        }

        * {
          box-sizing: border-box;
        }

        body {
          font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background-color: var(--md-background);
          color: var(--md-on-background);
          margin: 0;
          padding: 0;
          line-height: 1.5;
        }

        .md-top-app-bar {
          background-color: var(--md-primary);
          color: var(--md-on-primary);
          padding: 16px 24px;
          box-shadow: var(--md-elevation-1);
          display: flex;
          align-items: center;
          justify-content: space-between;
          position: sticky;
          top: 0;
          z-index: 1000;
        }

        .md-top-app-bar-title {
          font-size: 22px;
          font-weight: 500;
          letter-spacing: 0.15px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .md-top-app-bar-actions {
          display: flex;
          gap: 8px;
          align-items: center;
        }

        .md-button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 10px 16px;
          border: none;
          border-radius: var(--md-border-radius-large);
          font-size: 14px;
          font-weight: 500;
          line-height: 20px;
          cursor: pointer;
          transition: all 0.2s ease;
          text-decoration: none;
          min-height: 40px;
          gap: 4px;
        }

        .md-button-text {
          background-color: transparent;
          color: var(--md-on-primary);
        }

        .md-button-text:hover {
          background-color: rgba(255, 255, 255, 0.12);
        }

        .md-container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 24px;
          display: grid;
          grid-template-columns: 350px 1fr;
          gap: 24px;
          height: calc(100vh - 80px);
        }

        .conversations-panel {
          background: var(--md-surface);
          border-radius: var(--md-border-radius-large);
          box-shadow: var(--md-elevation-1);
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }

        .conversations-header {
          padding: 20px;
          border-bottom: 1px solid var(--md-outline-variant);
          font-size: 18px;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .conversations-list {
          flex: 1;
          overflow-y: auto;
        }

        .conversation-item {
          padding: 16px 20px;
          border-bottom: 1px solid var(--md-outline-variant);
          cursor: pointer;
          transition: background-color 0.2s;
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .conversation-item:hover {
          background-color: var(--md-surface-variant);
        }

        .conversation-item.active {
          background-color: rgba(63, 81, 181, 0.1);
          border-right: 3px solid var(--md-primary);
        }

        .conversation-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          background: var(--md-primary);
          color: var(--md-on-primary);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 500;
          font-size: 18px;
        }

        .conversation-info {
          flex: 1;
          min-width: 0;
        }

        .conversation-name {
          font-weight: 500;
          margin-bottom: 4px;
        }

        .conversation-preview {
          font-size: 14px;
          color: #666;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .conversation-meta {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 4px;
        }

        .conversation-time {
          font-size: 12px;
          color: #666;
        }

        .unread-badge {
          background: var(--md-primary);
          color: var(--md-on-primary);
          border-radius: 12px;
          padding: 2px 8px;
          font-size: 12px;
          font-weight: 500;
          min-width: 20px;
          text-align: center;
        }

        .chat-panel {
          background: var(--md-surface);
          border-radius: var(--md-border-radius-large);
          box-shadow: var(--md-elevation-1);
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }

        .chat-header {
          padding: 20px;
          border-bottom: 1px solid var(--md-outline-variant);
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .chat-header-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: var(--md-primary);
          color: var(--md-on-primary);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 500;
        }

        .chat-header-info h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 500;
        }

        .chat-header-info p {
          margin: 0;
          font-size: 14px;
          color: #666;
        }

        .chat-messages {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .message {
          display: flex;
          gap: 8px;
          max-width: 70%;
        }

        .message.sent {
          align-self: flex-end;
          flex-direction: row-reverse;
        }

        .message.received {
          align-self: flex-start;
        }

        .message-content {
          background: var(--md-surface-variant);
          padding: 12px 16px;
          border-radius: var(--md-border-radius-medium);
          font-size: 14px;
          line-height: 1.4;
        }

        .message.sent .message-content {
          background: var(--md-primary);
          color: var(--md-on-primary);
        }

        .message-time {
          font-size: 12px;
          color: #666;
          margin-top: 4px;
          text-align: right;
        }

        .message.received .message-time {
          text-align: left;
        }

        .chat-input {
          padding: 20px;
          border-top: 1px solid var(--md-outline-variant);
          display: flex;
          gap: 12px;
          align-items: center;
        }

        .chat-input input {
          flex: 1;
          padding: 12px 16px;
          border: 1px solid var(--md-outline);
          border-radius: var(--md-border-radius-large);
          font-size: 14px;
          outline: none;
        }

        .chat-input input:focus {
          border-color: var(--md-primary);
        }

        .send-button {
          background: var(--md-primary);
          color: var(--md-on-primary);
          border: none;
          border-radius: 50%;
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .send-button:hover {
          background: var(--md-primary-dark);
        }

        .empty-state {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          color: #666;
          text-align: center;
        }

        .empty-state .material-icons {
          font-size: 64px;
          margin-bottom: 16px;
          color: #ccc;
        }

        @media (max-width: 768px) {
          .md-container {
            grid-template-columns: 1fr;
            height: auto;
            min-height: calc(100vh - 80px);
          }
          
          .conversations-panel {
            order: 2;
          }
          
          .chat-panel {
            order: 1;
            min-height: 60vh;
          }
        }
    </style>
</head>
<body>

<div class="md-top-app-bar">
    <div class="md-top-app-bar-title">
        <span class="material-icons">chat</span>
        Messages
    </div>
    <div class="md-top-app-bar-actions">
        <a href="feed.html" class="md-button md-button-text">
            <span class="material-icons">dynamic_feed</span>
            Feed
        </a>
        <a href="friends_list.html" class="md-button md-button-text">
            <span class="material-icons">people</span>
            Friends
        </a>
        <a href="profile.html" class="md-button md-button-text">
            <span class="material-icons">account_circle</span>
            Profile
        </a>
    </div>
</div>

<div class="md-container">
    <div class="conversations-panel">
        <div class="conversations-header">
            <span class="material-icons">chat_bubble_outline</span>
            Conversations
        </div>
        <div class="conversations-list" id="conversationsList">
            <div class="empty-state">
                <span class="material-icons">chat</span>
                <h3>No conversations yet</h3>
                <p>Start chatting with your friends!</p>
            </div>
        </div>
    </div>

    <div class="chat-panel">
        <div id="emptyChat" class="empty-state">
            <span class="material-icons">question_answer</span>
            <h3>Select a conversation</h3>
            <p>Choose a friend to start messaging</p>
        </div>
        
        <div id="activeChat" style="display: none; height: 100%; display: flex; flex-direction: column;">
            <div class="chat-header" id="chatHeader">
                <div class="chat-header-avatar" id="chatAvatar">F</div>
                <div class="chat-header-info">
                    <h3 id="chatName">Friend Name</h3>
                    <p id="chatUsername">@username</p>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
            </div>
            
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="send-button" onclick="sendMessage()">
                    <span class="material-icons">send</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentChatFriendId = null;
    let conversations = [];
    let currentUserId = null;

    function getTokenFromCookie() {
        const match = document.cookie.match(/(^| )Authorization=([^;]+)/);
        return match ? decodeURIComponent(match[2]) : null;
    }

    function loadCurrentUserId() {
        const token = getTokenFromCookie();
        if (!token) {
            window.location.href = 'login.html';
            return;
        }
        
        fetch('/api/users/current-user-id', {
            method: 'GET',
            headers: {
                'Authorization': token
            }
        })
        .then(res => {
            if (!res.ok) {
                if (res.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }
                throw new Error('Failed to get user ID');
            }
            return res.json();
        })
        .then(data => {
            currentUserId = data.userId;
            loadConversations(); // Load conversations after getting user ID
        })
        .catch(err => {
            console.error('Error loading user ID:', err);
        });
    }
        const token = getTokenFromCookie();
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        fetch('/api/messages/conversations', {
            method: 'GET',
            headers: {
                'Authorization': token
            }
        })
        .then(res => {
            if (!res.ok) {
                if (res.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }
                throw new Error('Failed to load conversations');
            }
            return res.json();
        })
        .then(data => {
            conversations = data.conversations || [];
            displayConversations();
        })
        .catch(err => {
            console.error('Error loading conversations:', err);
        });
    }

    function displayConversations() {
        const container = document.getElementById('conversationsList');
        
        if (conversations.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">chat</span>
                    <h3>No conversations yet</h3>
                    <p>Start chatting with your friends!</p>
                </div>
            `;
            return;
        }

        let html = '';
        conversations.forEach(conv => {
            const partner = conv.partner;
            const lastMessage = conv.lastMessage;
            const unreadCount = conv.unreadCount || 0;
            
            const initials = partner.name ? partner.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
            const preview = lastMessage ? lastMessage.messageText : 'No messages yet';
            const time = lastMessage ? formatTime(lastMessage.sentAt) : '';
            
            html += `
                <div class="conversation-item ${currentChatFriendId === partner.userID ? 'active' : ''}" 
                     onclick="openChat(${partner.userID})">
                    <div class="conversation-avatar">${initials}</div>
                    <div class="conversation-info">
                        <div class="conversation-name">${escapeHtml(partner.name || 'Unknown')}</div>
                        <div class="conversation-preview">${escapeHtml(preview)}</div>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">${time}</div>
                        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function openChat(friendId) {
        currentChatFriendId = friendId;
        
        // Update UI
        document.getElementById('emptyChat').style.display = 'none';
        document.getElementById('activeChat').style.display = 'flex';
        
        // Update active conversation in list
        displayConversations();
        
        // Load chat
        loadChat(friendId);
    }

    function loadChat(friendId) {
        const token = getTokenFromCookie();
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        fetch(`/api/messages/conversation/${friendId}`, {
            method: 'GET',
            headers: {
                'Authorization': token
            }
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed to load chat');
            return res.json();
        })
        .then(data => {
            const friend = data.friend;
            const messages = data.messages || [];
            
            // Update chat header
            const initials = friend.name ? friend.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
            document.getElementById('chatAvatar').textContent = initials;
            document.getElementById('chatName').textContent = friend.name || 'Unknown';
            document.getElementById('chatUsername').textContent = '@' + (friend.userName || 'unknown');
            
            // Display messages
            displayMessages(messages);
            
            // Refresh conversations to update unread counts
            loadConversations();
        })
        .catch(err => {
            console.error('Error loading chat:', err);
        });
    }

    function displayMessages(messages) {
        const container = document.getElementById('chatMessages');

        let html = '';
        messages.forEach(message => {
            const isSent = message.senderId === currentUserId;
            const time = formatTime(message.sentAt);
            
            html += `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-content">
                        ${escapeHtml(message.messageText)}
                        <div class="message-time">${time}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const messageText = input.value.trim();
        
        if (!messageText || !currentChatFriendId) return;

        const token = getTokenFromCookie();
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        const formData = new FormData();
        formData.append('receiverId', currentChatFriendId);
        formData.append('messageText', messageText);

        fetch('/api/messages/send', {
            method: 'POST',
            headers: {
                'Authorization': token
            },
            body: formData
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed to send message');
            return res.json();
        })
        .then(data => {
            input.value = '';
            loadChat(currentChatFriendId); // Reload to show new message
        })
        .catch(err => {
            console.error('Error sending message:', err);
            alert('Failed to send message');
        });
    }

    function getCurrentUserId() {
        if (currentUserId) return currentUserId;
        
        const token = getTokenFromCookie();
        if (!token) return null;
        
        // Fetch current user ID synchronously for simplicity
        fetch('/api/users/current-user-id', {
            method: 'GET',
            headers: {
                'Authorization': token
            }
        })
        .then(res => res.json())
        .then(data => {
            currentUserId = data.userId;
        })
        .catch(err => console.error('Error getting user ID:', err));
        
        return currentUserId;
    }

    function formatTime(dateTime) {
        if (!dateTime) return '';
        const date = new Date(dateTime);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 24 * 60 * 60 * 1000) { // Less than 24 hours
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } else {
            return date.toLocaleDateString();
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Auto-refresh conversations every 30 seconds
    setInterval(loadConversations, 30000);

    window.onload = loadCurrentUserId;
</script>

</body>
</html>