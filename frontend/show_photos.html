

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Episode Photos - CringeBook</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Material Design 3 Color Scheme and Components */
        :root {
          --md-primary: #3f51b5;
          --md-primary-dark: #303f9f;
          --md-primary-light: #5c6bc0;
          --md-secondary: #03dac6;
          --md-surface: #ffffff;
          --md-surface-variant: #f5f5f5;
          --md-background: #fafafa;
          --md-error: #b00020;
          --md-on-primary: #ffffff;
          --md-on-surface: #000000;
          --md-on-background: #000000;
          --md-outline: #e0e0e0;
          --md-outline-variant: #f0f0f0;
          --md-border-radius-small: 8px;
          --md-border-radius-medium: 12px;
          --md-border-radius-large: 16px;
          --md-elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.12), 0px 1px 2px rgba(0, 0, 0, 0.24);
          --md-elevation-2: 0px 3px 6px rgba(0, 0, 0, 0.16), 0px 3px 6px rgba(0, 0, 0, 0.23);
        }

        * {
          box-sizing: border-box;
        }

        body {
          font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background-color: var(--md-background);
          color: var(--md-on-background);
          margin: 0;
          padding: 0;
          line-height: 1.5;
        }

        .md-top-app-bar {
          background-color: var(--md-primary);
          color: var(--md-on-primary);
          padding: 16px 24px;
          box-shadow: var(--md-elevation-1);
          display: flex;
          align-items: center;
          justify-content: space-between;
          position: sticky;
          top: 0;
          z-index: 1000;
        }

        .md-top-app-bar-title {
          font-size: 22px;
          font-weight: 500;
          letter-spacing: 0.15px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .md-top-app-bar-actions {
          display: flex;
          gap: 8px;
          align-items: center;
        }

        .md-button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 10px 16px;
          border: none;
          border-radius: var(--md-border-radius-large);
          font-size: 14px;
          font-weight: 500;
          line-height: 20px;
          cursor: pointer;
          transition: all 0.2s ease;
          text-decoration: none;
          min-height: 40px;
          gap: 4px;
        }

        .md-button-text {
          background-color: transparent;
          color: var(--md-on-primary);
        }

        .md-button-text:hover {
          background-color: rgba(255, 255, 255, 0.12);
        }

        .md-button-filled {
          background-color: white;
          color: var(--md-primary);
        }

        .md-button-filled:hover {
          background-color: #f5f5f5;
          box-shadow: var(--md-elevation-1);
        }

        .md-container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 24px;
        }

        .md-grid {
          display: grid;
          gap: 20px;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .photo-thumb {
          width: 100%;
          height: 240px;
          object-fit: cover;
          border-radius: var(--md-border-radius-medium);
          box-shadow: var(--md-elevation-1);
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .photo-thumb:hover {
          transform: translateY(-2px);
          box-shadow: var(--md-elevation-2);
        }

        .message {
          text-align: center;
          padding: 48px 24px;
          color: #666;
          background: var(--md-surface-variant);
          border-radius: var(--md-border-radius-medium);
          margin: 24px 0;
        }

        .error-message {
          color: var(--md-error);
          background: #ffebee;
        }

        .loading-message {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }

        /* Lightbox styles */
        .lightbox {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0,0,0,0.95);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          overflow: hidden;
        }

        .lightbox-content {
          display: flex;
          flex-direction: column;
          align-items: center;
          height: 100%;
          width: 100%;
          justify-content: center;
          padding: 20px;
        }

        .lightbox img {
          max-height: calc(100vh - 120px);
          max-width: 95vw;
          object-fit: contain;
          border-radius: var(--md-border-radius-medium);
          box-shadow: var(--md-elevation-2);
        }

        #photoCounter {
          color: white;
          font-size: 18px;
          margin-top: 20px;
          padding: 8px 16px;
          background: rgba(0,0,0,0.5);
          border-radius: var(--md-border-radius-large);
        }

        .nav-btn {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          background: rgba(255,255,255,0.9);
          color: var(--md-primary);
          border: none;
          font-size: 18px;
          padding: 12px 16px;
          cursor: pointer;
          border-radius: 50%;
          width: 56px;
          height: 56px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
        }

        .nav-btn:hover {
          background: white;
          box-shadow: var(--md-elevation-2);
        }

        .nav-left {
          left: 30px;
        }

        .nav-right {
          right: 30px;
        }

        .close-btn {
          position: absolute;
          top: 20px;
          right: 30px;
          background: rgba(255,255,255,0.9);
          color: var(--md-primary);
          border: none;
          padding: 12px;
          border-radius: 50%;
          cursor: pointer;
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
        }

        .close-btn:hover {
          background: white;
          box-shadow: var(--md-elevation-2);
        }

        @media (max-width: 768px) {
          .md-container {
            padding: 16px;
          }
          
          .md-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
          }
          
          .photo-thumb {
            height: 200px;
          }
          
          .md-top-app-bar {
            padding: 12px 16px;
          }
          
          .md-top-app-bar-title {
            font-size: 20px;
          }
          
          .nav-btn {
            width: 48px;
            height: 48px;
            padding: 8px;
          }
          
          .nav-left {
            left: 10px;
          }
          
          .nav-right {
            right: 10px;
          }
          
          .close-btn {
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
          }
        }
    </style>
</head>
<body>

<div class="md-top-app-bar">
    <div class="md-top-app-bar-title">
        <span class="material-icons">photo_library</span>
        Episode Photos
    </div>
    <div class="md-top-app-bar-actions">
        <button onclick="goBackToEpisodes()" class="md-button md-button-text">
            <span class="material-icons">arrow_back</span>
            Back to Episodes
        </button>
        <button id="addPhotoBtn" onclick="goToAddPhoto()" class="md-button md-button-filled">
            <span class="material-icons">add_a_photo</span>
            Add Photo
        </button>
    </div>
</div>

<div class="md-container">
    <div class="md-grid" id="photoContainer"></div>
    <div class="message" id="message" style="display: none;"></div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
    <button class="close-btn" onclick="closeLightbox()">
        <span class="material-icons">close</span>
    </button>

    <div class="lightbox-content">
        <img id="lightboxImg" src="" alt="Full Photo">
        <div id="photoCounter"></div>
    </div>

    <button class="nav-btn nav-left" onclick="navigate(-1)">
        <span class="material-icons">chevron_left</span>
    </button>
    <button class="nav-btn nav-right" onclick="navigate(1)">
        <span class="material-icons">chevron_right</span>
    </button>
</div>

<script>
    const photoList = [];
    let currentIndex = 0;

    function getTokenFromCookie() {
      const match = document.cookie.match(/(^| )Authorization=([^;]+)/);
      return match ? decodeURIComponent(match[2]) : null;
    }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function photoUrl(filename) {
      return `/get_photo_from_url?url=${encodeURIComponent(filename)}`;
    }

    function fetchPhotos() {
      const token = getTokenFromCookie();
      const episodeId = getQueryParam("episodeId");

      if (!token || !episodeId) {
        showMessage("Missing token or episode ID.", "error");
        return;
      }

      fetch(`/show_photos?episodeId=${episodeId}`, {
        headers: {
          "Authorization": token
        }
      })
      .then(res => {
        if (!res.ok) throw new Error("Failed to load photos");
        return res.json();
      })
      .then(data => {
        const photos = data.photos || data; // Handle both old and new format
        const isOwner = data.isOwner !== undefined ? data.isOwner : true; // Default to owner for backward compatibility
        
        const container = document.getElementById("photoContainer");
        container.innerHTML = "";

        // Hide add button if not owner
        const addButton = document.getElementById("addPhotoBtn");
        if (addButton) {
          addButton.style.display = isOwner ? "flex" : "none";
        }

        if (!photos || photos.length === 0) {
          showMessage("No photos found.", "info");
          return;
        }

        photos.forEach((photo, index) => {
          photoList.push(photo);

          const img = document.createElement("img");
          img.className = "photo-thumb";
          img.src = photoUrl(photo.photoUrl);  // this is the `photo_url`
          img.alt = "Episode Photo";
          img.onclick = () => openLightbox(index);

          container.appendChild(img);
        });
      })
      .catch(err => {
        showMessage(err.message, "error");
      });
    }

    function showMessage(text, type = "info") {
      const messageEl = document.getElementById("message");
      messageEl.innerHTML = `
        <div class="loading-message">
          <span class="material-icons">${type === "error" ? "error" : "info"}</span>
          ${text}
        </div>
      `;
      messageEl.className = `message ${type === "error" ? "error-message" : ""}`;
      messageEl.style.display = "block";
    }

    function openLightbox(index) {
      currentIndex = index;
<!--      document.getElementById("lightboxImg").src = photoUrl(photoList[index].photoUrl);-->
      updateLightbox();
      document.getElementById("lightbox").style.display = "flex";
    }
    function updateLightbox() {
      const total = photoList.length;
      const photo = photoList[currentIndex];
      document.getElementById("lightboxImg").src = photoUrl(photo.photoUrl);
      document.getElementById("photoCounter").textContent = `${currentIndex + 1} / ${total}`;
    }

    function closeLightbox() {
      document.getElementById("lightbox").style.display = "none";
    }

    function navigate(step) {
      currentIndex += step;
      if (currentIndex < 0) currentIndex = photoList.length - 1;
      else if (currentIndex >= photoList.length) currentIndex = 0;
      updateLightbox();
<!--      document.getElementById("lightboxImg").src = photoUrl(photoList[currentIndex].photoUrl);-->
    }

    function goBackToEpisodes() {
      const memoryId = sessionStorage.getItem("currentMemoryId");
      if (memoryId) {
        window.location.href = `show_episodes.html?memoryId=${memoryId}`;
      }
    }

    function goToAddPhoto() {
      const episodeId = getQueryParam("episodeId");
      if (episodeId) {
        window.location.href = `add_photo.html?episodeId=${episodeId}`;
      }
    }

    window.onload = fetchPhotos;
</script>

</body>
</html>
