<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Picture - CringeBook</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="notification-service.js"></script>
    <style>
        /* Material Design 3 Color Scheme and Components */
        :root {
          --md-primary: #3f51b5;
          --md-primary-dark: #303f9f;
          --md-primary-light: #5c6bc0;
          --md-secondary: #03dac6;
          --md-surface: #ffffff;
          --md-surface-variant: #f5f5f5;
          --md-background: #fafafa;
          --md-error: #b00020;
          --md-on-primary: #ffffff;
          --md-on-surface: #000000;
          --md-on-background: #000000;
          --md-outline: #e0e0e0;
          --md-outline-variant: #f0f0f0;
          --md-border-radius-small: 8px;
          --md-border-radius-medium: 12px;
          --md-border-radius-large: 16px;
          --md-elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.12), 0px 1px 2px rgba(0, 0, 0, 0.24);
          --md-elevation-2: 0px 3px 6px rgba(0, 0, 0, 0.16), 0px 3px 6px rgba(0, 0, 0, 0.23);
        }

        * {
          box-sizing: border-box;
        }

        body {
          font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background-color: var(--md-background);
          color: var(--md-on-background);
          margin: 0;
          padding: 0;
          line-height: 1.5;
        }

        .md-top-app-bar {
          background-color: var(--md-primary);
          color: var(--md-on-primary);
          padding: 16px 24px;
          box-shadow: var(--md-elevation-1);
          display: flex;
          align-items: center;
          justify-content: space-between;
          position: sticky;
          top: 0;
          z-index: 1000;
        }

        .md-top-app-bar-title {
          font-size: 22px;
          font-weight: 500;
          letter-spacing: 0.15px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .md-button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 10px 16px;
          border: none;
          border-radius: var(--md-border-radius-large);
          font-size: 14px;
          font-weight: 500;
          line-height: 20px;
          cursor: pointer;
          transition: all 0.2s ease;
          text-decoration: none;
          min-height: 40px;
          gap: 4px;
        }

        .md-button-text {
          background-color: transparent;
          color: var(--md-on-primary);
        }

        .md-button-text:hover {
          background-color: rgba(255, 255, 255, 0.12);
        }

        .md-button-filled {
          background-color: var(--md-primary);
          color: var(--md-on-primary);
        }

        .md-button-filled:hover {
          background-color: var(--md-primary-dark);
          box-shadow: var(--md-elevation-1);
        }

        .md-container {
          max-width: 600px;
          margin: 0 auto;
          padding: 24px;
        }

        .profile-section {
          background: var(--md-surface);
          border-radius: var(--md-border-radius-medium);
          box-shadow: var(--md-elevation-1);
          padding: 32px;
          text-align: center;
          margin-bottom: 24px;
        }

        .current-profile-pic {
          width: 120px;
          height: 120px;
          border-radius: 50%;
          margin: 0 auto 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: var(--md-surface-variant);
          color: #666;
          font-size: 48px;
          overflow: hidden;
        }

        .current-profile-pic img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }

        .upload-section {
          background: var(--md-surface);
          border-radius: var(--md-border-radius-medium);
          box-shadow: var(--md-elevation-1);
          padding: 24px;
        }

        .file-input-container {
          margin-bottom: 24px;
        }

        .file-input-label {
          display: block;
          margin-bottom: 8px;
          font-weight: 500;
          color: var(--md-on-surface);
        }

        .file-input {
          width: 100%;
          padding: 12px;
          border: 2px dashed var(--md-outline);
          border-radius: var(--md-border-radius-medium);
          background: var(--md-surface-variant);
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .file-input:hover {
          border-color: var(--md-primary);
          background: rgba(63, 81, 181, 0.04);
        }

        .message {
          margin: 16px 0;
          padding: 12px;
          border-radius: var(--md-border-radius-small);
          display: none;
        }

        .message.success {
          background: #e8f5e8;
          color: #2e7d32;
          border: 1px solid #4caf50;
        }

        .message.error {
          background: #ffebee;
          color: #c62828;
          border: 1px solid #f44336;
        }

        @media (max-width: 768px) {
          .md-container {
            padding: 16px;
          }
          
          .profile-section,
          .upload-section {
            padding: 16px;
          }
        }
    </style>
</head>
<body>

<div class="md-top-app-bar">
    <div class="md-top-app-bar-title">
        <span class="material-icons">account_circle</span>
        Profile Picture
    </div>
    <a href="show_memory.html" class="md-button md-button-text">
        <span class="material-icons">arrow_back</span>
        Back
    </a>
</div>

<div class="md-container">
    <div class="profile-section">
        <div class="current-profile-pic" id="currentProfilePic">
            <span class="material-icons">person</span>
        </div>
        <h2>Current Profile Picture</h2>
        <p>Upload a new image to update your profile picture</p>
    </div>

    <div class="upload-section">
        <h3>Upload New Picture</h3>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="file-input-container">
                <label class="file-input-label" for="imageFile">Choose Image File</label>
                <input type="file" id="imageFile" name="image" accept="image/*" class="file-input" required>
            </div>
            <div class="message" id="message"></div>
            <button type="submit" class="md-button md-button-filled">
                <span class="material-icons">upload</span>
                Upload Picture
            </button>
        </form>
    </div>
</div>

<script>
    function getTokenFromCookie() {
        const match = document.cookie.match(/(^| )Authorization=([^;]+)/);
        return match ? decodeURIComponent(match[2]) : null;
    }

    function showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';
    }

    function hideMessage() {
        document.getElementById('message').style.display = 'none';
    }

    function loadCurrentProfilePicture() {
        // For now, we'll just show the default avatar
        // In a full implementation, you'd fetch the current user's profile picture
        const currentPic = document.getElementById('currentProfilePic');
        // This could be enhanced to show the actual current profile picture
    }

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const token = getTokenFromCookie();
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        const fileInput = document.getElementById('imageFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showMessage('Please select an image file', 'error');
            return;
        }

        // Check file size (limit to 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showMessage('File size must be less than 5MB', 'error');
            return;
        }

        // Check file type
        if (!file.type.startsWith('image/')) {
            showMessage('Please select a valid image file', 'error');
            return;
        }

        hideMessage();

        const formData = new FormData();
        formData.append('image', file);

        try {
            const response = await fetch('/api/users/profile-picture', {
                method: 'POST',
                headers: {
                    'Authorization': token
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                showMessage('Profile picture updated successfully!', 'success');
                
                // Update the preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const currentPic = document.getElementById('currentProfilePic');
                    currentPic.innerHTML = `<img src="${e.target.result}" alt="Profile Picture">`;
                };
                reader.readAsDataURL(file);
                
                // Reset form
                fileInput.value = '';
            } else {
                showMessage(result.error || 'Failed to upload profile picture', 'error');
            }
        } catch (error) {
            showMessage('Error uploading profile picture', 'error');
            console.error('Upload error:', error);
        }
    });

    // Load current profile picture on page load
    window.onload = loadCurrentProfilePicture;
</script>

</body>
</html>